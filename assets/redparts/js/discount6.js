"use strict";_.extend(Backbone.Model.prototype,Backbone.Validation.mixin);IB.models.LoginFormModel=Backbone.Model.extend({validation:{username:[{required:true,msg:"Please enter your email id or phone"}],password:{required:true,msg:"Please enter your password."}}});IB.models.SignUpFormModel=Backbone.Model.extend({defaults:{new_user:1,subscribe:1,category_in:"",},validation:{firstname:[{required:true,msg:"First Name is required."},{pattern:/^[a-zA-Z0-9]+$/,msg:"Special Character not allowed in name."}],lastname:[{required:false,msg:"Last name is optional"},{pattern:/^[a-zA-Z0-9]*$/,msg:"Special Character not allowed in name."}],username:[{required:true,msg:"Please enter your email id"},{pattern:'email',msg:"Please enter correct email"}],password:{required:true,msg:"Please enter your password."},phone:[{required:true,msg:"Please enter your phone number."},{minLength:10,maxLength:12,pattern:/^\d*$/,msg:"Enter a valid phone number."}],tin_no:function(value,attr,computedState){if(value){var state=value.slice(0,2);if(!(parseInt(state)<38&&parseInt(state)>0)){return'Please enter valid state code';}
else if(value.length==11&&!IB.is_only_gstin_req){var res=/^[0-3][0-9]\d{9}$/.test(value);if(!res){return"Please enter valid Tin Number";}}else{var res=/^[0-3][0-9]\w{13}$/.test(value);if(!res){return"Please enter valid GSTIN number";}}}}},});IB.views.LoginSignUpView=IB.views.BaseView.extend({initialize:function(){this.loginModel=new IB.models.LoginFormModel();this.signUpModel=new IB.models.SignUpFormModel();this.preferredIndustry=[];this.registrationSccessful=false;this.messaage=this.messaage;$(document).on('keydown',$.proxy(this.closePopUpEsc,this));if(IB.PRODUCTION){this.loginRegisterUrl='https://'+window.location.host+'/new/login/or/register/';}else{this.loginRegisterUrl='/new/login/or/register/';}},events:{'click .AH_PopUpClose':'closePopUp','click .AH_SignUpBtn':'showSignUp','click .AH_LoginBtn':'showLogin','click .AH_ContinueToLogin':'continueToLogin','submit .AH_LoginForm':'doLogin','submit .AH_SignUpForm':'signUp','click .AH_PreferedIndustry':'togglePreferredIndustry','click #id_email_verification':'doVerification','click .genOverlayBg':'closePopUp'},getParameterByName:function(name,url){if(!url)url=window.location.href;name=name.replace(/[\[\]]/g,"\\$&");var regex=new RegExp("[?&]"+name+"(=([^&#]*)|&|#|$)"),results=regex.exec(url);if(!results)return null;if(!results[2])return'';return decodeURIComponent(results[2].replace(/\+/g," "));},validateUsername:function(e){$(".AH_username_error").hide();$(".AH_user_tick").removeClass("tick-mark-circle cross-mark-circle").hide()
var EMAIL_REGEX=/^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/i;if($(e.target).val()&&EMAIL_REGEX.test($(e.target).val())){$(".AH_user_tick").addClass("tick-mark-circle").show()}
else if(!$(e.target).val()){$(".AH_user_tick").hide();}
else{$(".AH_user_tick").addClass("cross-mark-circle").show();}},serialize:function(){return{popupType:this.popupType,registrationSccessful:this.registrationSccessful,registeredEmail:this.signUpModel.get('username'),domain:this.email_domain(this.signUpModel.get('username')),message:this.message,}},email_domain:function(email){if(email){return email.split("@")[1]}
return""},modelInvalid:function(model,errors){_.each(errors,function(error,name){this.showInputErrors(name,error);},this);},showInputErrors:function(target,error){this.$("input[name="+target+"]").val("")
this.$('.AH_'+target+'_error').text(error).show();},showSignUp:function(){this.popupType='signup';this.render();},showLogin:function(){this.popupType='login';this.render();},continueToLogin:function(){this.registrationSccessful=false;this.showLogin();},doLogin:function(e){e.preventDefault();var formDataSerialized=$(e.currentTarget).serializeArray();_.each(formDataSerialized,function(item){this.loginModel.set(item.name,item.value);this.$('.AH_'+item.name+'_error').text('').hide();},this);var errors=this.loginModel.validate();if(!_.isEmpty(errors)){this.modelInvalid(this.loginModel,errors);return;}
this.$('.AH_SignIn_Error').text('').hide();var that=this;var next=this.getParameterByName("next");var url=this.loginRegisterUrl;var client_id=this.getParameterByName("client_id");var redirect_uri=this.getParameterByName("redirect_uri");var response_type=this.getParameterByName("response_type");this.loginModel.set('fcmToken',window.localStorage.getItem('fcmToken'))
$.ajax({url:url,headers:{"Access-Control-Allow-Origin":"*"},type:"POST",data:this.loginModel.toJSON(),crossDomain:true,success:function(res){if(res.msg!='200'){that.$('.AH_SignIn_Error').html(res.msg).show();}else{if(response_type==='id_token'&&client_id!=null&&redirect_uri!=null){var idToken;var tokenUrl='/shipa-freight/get-id-token/';$.ajax({url:tokenUrl,type:"GET",data:{"client_id":client_id},success:function(res){if(res.msg=='success'){idToken=res.id_token;redirect_uri=redirect_uri+'?'+response_type+'='+idToken;window.location.href=redirect_uri;}}})}
else{if(that.popupType=="footer-login-quickorder"){window.localStorage.setItem('footer-login-type','quickorder')}
if(that.popupType=="footer-login-purchaseListContent"){window.localStorage.setItem('footer-login-type','purchaseListContent')}
if(typeof pagename!="undefined"&&pagename==="shipafreight"){window.location.href=quote_url;return;}
var tmpl=_.template($('#AH_VirtualLoginFormTmpl').html())({user:that.loginModel.toJSON()});$('body').append(tmpl).submit();if(next!=null&&next!=""&&next!=undefined){$('#AH_VirtualLoginForm').attr("action","/user/login/?next="+next);}
$('#AH_VirtualLoginForm').submit();}}},error:function(err){that.$('.AH_SignIn_Error').text('Server Error').show();}});},signUp:function(e){e.preventDefault();var formDataSerialized=$(e.currentTarget).serializeArray();_.each(formDataSerialized,function(item){this.signUpModel.set(item.name,item.value);this.$('.AH_'+item.name+'_error').text('').hide();},this);var errors=this.signUpModel.validate();if(!_.isEmpty(errors)){this.modelInvalid(this.signUpModel,errors);return;}
this.$('.AH_SignUp_Error').text('').hide();if(this.isSigningUp)return;this.isSigningUp=true;var data=this.signUpModel.toJSON();if(typeof pagename!="undefined"){data['pagename']=pagename;}
var that=this;$.ajax({url:this.loginRegisterUrl,type:"POST",data:data,success:function(res){that.isSigningUp=false;if(res.msg!='200'){that.$('.AH_SignUp_Error').text(res.msg).show();}
else if(typeof pagename!="undefined"&&pagename==="shipafreight"){window.location.href=quote_url;return;}
else{var client_id=getParameterByName("client_id");var redirect_uri=getParameterByName("redirect_uri");var response_type=getParameterByName("response_type");if(response_type==='id_token'&&client_id!=null&&redirect_uri!=null){var idToken;var tokenUrl='/shipa-freight/get-id-token/';var data={'email':that.signUpModel.toJSON()['username'],'client_id':client_id};$.ajax({url:tokenUrl,type:"POST",data:data,success:function(res){if(res.msg=='success'){idToken=res.id_token;redirect_uri=redirect_uri+'?'+response_type+'='+idToken;window.location.href=redirect_uri;}}})}
else{that.registrationSccessful=true;that.render();}}
iba('click','register','',that.signUpModel.toJSON());},error:function(err){that.isSigningUp=false;that.$('.AH_SignUp_Error').text('Server Error').show();}});},togglePreferredIndustry:function(e){var target=$(e.currentTarget);var id=target.data('id');if(target.find('.AH_Checkbox').hasClass('hide')){this.preferredIndustry[this.preferredIndustry.length]=id;}else{this.preferredIndustry=_.reject(this.preferredIndustry,function(item){return item===id});}
var category_in=_.reduce(this.preferredIndustry,function(memo,item){return memo+item+',';},'');category_in=category_in.slice(0,category_in.length-1);this.signUpModel.set('category_in',category_in);target.find('.AH_Checkbox').toggleClass('hide');},closePopUp:function(){this.removeView();this.remove();},closePopUpEsc:function(e){if(e.keyCode&&e.which==27){this.removeView();this.remove();}},doVerification:function(e){e.preventDefault();var email=$('#id_email_verification').attr('data-val');var url='/verification_email/';this.$('.AH_SignIn_Error').text('').hide();var that=this;$.ajax({type:'POST',url:url,data:{'username':email,'csrfmiddlewaretoken':getCookie('csrftoken')},success:function(res){if(res.msg!='200'){that.$('.AH_SignIn_Error').text(res.msg).show();}else{that.registrationSccessful=true;that.popupType='signup';that.render();}},error:function(err){that.$('.AH_SignUp_Error').text('Server Error').show();}});},});function showLoginPopup(type){if(['login','signup'].indexOf(type)===-1){type='login';}
var tmpl=$('#AH_LoginSignUpTmpl').html();$('body').append(tmpl);IB.globals.views.loginSignupView=new IB.views.LoginSignUpView({el:'#AH_LoginSignUpView',template:_.template($('#AH_LoginSignUpTmpl').html()),popupType:type,}).render();}
$(function(){$('.AH_LoginPopUpBtn').on('click',function(){showLoginPopup('login');setTimeout(function(){ui.start("#AH_firebaseOnLoginPopup",firebaseUIConfig);},10)});$('.AH_SignUpPopUpBtn , .AH_LoginBtn').on('click',function(){showLoginPopup('signup');});$('body').on('click','.AH_OpenForgotPassword',function(e){if(IB.globals.views.loginSignupView){IB.globals.views.loginSignupView.removeView();IB.globals.views.loginSignupView.remove();}
$('.AH_ForgotPassMsg').attr('style','display: none;')
$('.AH_ForgotPassForm').find('input.AH_ForgotEmail').val("");setTimeout(function(){$('#AH_ForgotPassPopUpView').addClass('in');},100);});$('#AH_ForgotPassSubmit').click(function(e){$.post('/user/forgot_password/',$('.AH_ForgotPassForm').serialize()).done(function(response){var data=JSON.parse(response);IB.log(data);if(data.success==="success"){$('#AH_ForgotPassPopUpView').removeClass('in');$('#AH_ResetPassPopUpView').addClass('in');$(".AH_ResetPassForm").find("input.AH_ResetField").val("");$('.AH_ForgotPassMsg').attr('style','display: none;')
$('.AH_ResetPassMsg').attr('style','display: none;')
$('.AH_ForgotSuccessMsg').html(data.msg);}else{$('.AH_ForgotPassMsg').attr('style','display: block;').addClass('alert-mssg-div').find("span").text(data.msg);}}).fail(function(){$('.AH_ForgotPassMsg').attr('style','display: block;').addClass('alert-mssg-div').find("span").text("Oops! It's not you, something went wrong on our side.");});});$('.AH_ForgotEmail').keypress(function(e){if(e.which===13){e.preventDefault();$('#AH_ForgotPassSubmit').click();}});$('#AH_ResetPassword').click(function(e){var flagValidReset=true;$('.AH_ResetPassForm').find('input').each(function(){if($(this).prop('required')){if(!$(this).val()){flagValidReset=false;$('.AH_ResetPassMsg').attr('style','display: block;').addClass('alert-danger').text("Please fill all the fields");return;}}});if(!flagValidReset){return;}else{$.post('/user/reset_password/',$('.AH_ResetPassForm').serialize()).done(function(response){var data=JSON.parse(response);if(data.success==="success"){$('#AH_ResetPassPopUpView').removeClass('in');setTimeout(function(){$('#AH_ResetMsgPopup').addClass('in');},100);}else{$('.AH_ResetPassMsg').attr('style','display: block;').addClass('alert-danger').text(data.msg);}}).fail(function(){$('.AH_ResetPassMsg').attr('style','display: block;').addClass('alert-danger').text("Oops! It's not you, something went wrong on our side.");});}});$('.AH_ResetField').keypress(function(e){if(e.which===13){e.preventDefault();$('#AH_ResetPassword').click();}});$('.AH_ResendCode').click(function(){$.post('/user/forgot_password/',$('.AH_ForgotPassForm').serialize()).done(function(response){var data=JSON.parse(response);IB.log(data);if(data.success==="success"){$(".AH_ResetPassForm").find("input.AH_ResetField").val("");$('.AH_ForgotPassMsg').attr('style','display: none;')
$('.AH_ResetPassMsg').attr('style','display: none;')
$('.AH_ForgotSuccessMsg').html(data.msg);$('.AH_ResetPassMsg').attr('style','display: block;').addClass('success-msg').text("Code resent successfully!");}else{$('.AH_ResetPassMsg').attr('style','display: block;').addClass('alert-mssg-div').text(data.msg);}}).fail(function(){$('.AH_ResetPassMsg').attr('style','display: block;').addClass('alert-mssg-div').text("Oops! It's not you, something went wrong on our side.");});});$('.AH_PopUpClose, .genOverlayBg').click(function(){$('#AH_ForgotPassPopUpView').removeClass('in');$('#AH_ResetPassPopUpView').removeClass('in');$('#AH_ResetMsgPopup').removeClass('in');});$(document).on('keydown',function(e){if(e.keyCode&&e.keyCode==27){$('#AH_ForgotPassPopUpView').removeClass('in');$('#AH_ResetPassPopUpView').removeClass('in');$('#AH_ResetMsgPopup').removeClass('in');}});$('.AH_ResetLoginBtn').click(function(){$('#AH_ResetMsgPopup').removeClass('in');var tmpl=$('#AH_LoginSignUpTmpl').html();$('body').append(tmpl);IB.globals.views.loginSignupView=new IB.views.LoginSignUpView({el:'#AH_LoginSignUpView',template:_.template($('#AH_LoginSignUpTmpl').html()),popupType:'login'}).render();});});function isValidEmail(email){var email_pattern=/^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/;return email_pattern.test(email);}
function isValidPhone(phone){var phone_pattern=/^[6-9]\d{9}$/;return phone_pattern.test(phone);}
var otpcount;var otpCountVar=null;var backendTime;var backendTimeExecutor=null;function showTimer(){if(backendTime>0){--backendTime;$("#otpCounter").css({"display":"inline","float":"right"});minutesfromBack=Math.floor(backendTime/60);secondsfromBack=backendTime-minutesfromBack*60;document.getElementById("otpCounter").innerHTML="Resend enable after <span>"+minutesfromBack+":"+secondsfromBack+"</span>";}
else{clearInterval(backendTimeExecutor);backendTimeExecutor=null;$("#resendOTP").removeClass("resendOTPDisable");$("#otpCounter").css({"display":"none"});}}
function otpCountFn(){if(otpcount>0){--otpcount;$("#otpCounter").css({"display":"inline","float":"right"});document.getElementById("otpCounter").innerHTML="Resend enable after <span>"+otpcount+" seconds</span>";}else{clearInterval(otpCountVar);otpCountVar=null;$("#resendOTP").removeClass("resendOTPDisable");$("#otpCounter").css({"display":"none"});}}
$("#id_SignInBtn").submit(function(){if($("#username").val()=="")
$("#enterEmail").show();else
$("#enterEmail").hide();});function getLoginOTPPopUp(){removeMessages();var existing=window.localStorage.getItem("username");var username=document.getElementById("username").value;if(existing!=username){$('#resendOTP').removeClass('resendOTPDisable');$('#otpCounter').hide();$('.AH_SignIn_Error').hide();clearInterval(otpCountVar);otpCountVar=null;otpcount=1;clearInterval(backendTimeExecutor);backendTimeExecutor=null;}
if(isValidEmail(username)||isValidPhone(username)){window.localStorage.setItem("username",username);$("#loginByPWD").slideUp();$("#loginByOTP").slideDown();$.ajax({url:'/user/api/send-otp/',data:{'username':username},type:"POST",success:function(result){if(result["msg"]==200){window.localStorage.setItem("mode",result["mode"]);}}});if(username===""){$("#enterEmail").show();}
else{$("#enterEmail").hide();}}
else if(username===""){$("#enterEmail").show();$("#error").show();}
else{$("#enterEmail").hide();$("#error").text("Invalid Phone/Email");$("#error").show();}}
function loginByPasswordPopUp(){$("#otp").val("");$("#loginByPWD").slideDown();$("#loginByOTP").slideUp();}
function submitOTPPopUp(){removeMessages();var username=window.localStorage.getItem("username");var mode=window.localStorage.getItem("mode");var otp=document.getElementById("otp").value
$.ajax({url:'/user/api/login/',data:{"username":username,"otp":otp,"mode":mode},type:"POST",success:function(result){if(result["msg"]==200){if(typeof pagename!="undefined"&&pagename==="shipafreight"){window.location.href=quote_url;return;}
window.location.replace('/');}
else if(result["msg"]=="102"){email=result["accounts"];$("#multipleMobileUsers").append('<span class="error-mssg" id="noEmailSelected"></span>')
for(i=0;i<email.length;i++){$("#multipleMobileUsers #chooseEmailOverflow").append('<div class="form-control">'+'<label class="emailTxt">'+email[i]+'<input type="radio" name = "email" value='+i+'>'+'</label></div>')}
$("#multipleMobileUsers").append('<input type="email" placeholder="Enter Email ID" id="verificationEmailId"><button type="button" name="sign-in" value="sign-in" onclick="verifyEmail()">LOGIN</button>')
$("#multipleMobileUsers").show();$("#loginForm").hide();}
else if(result["msg"]=="101"){$("#loginForm").hide();$("#newRegisterationForm").show();if(result["mode"]=="phone"){$("#registerPhone").val(username);$("#registerPhone").prop("readonly",true);}
else{$("#registerEmail").val(username);$("#registerEmail").prop("readonly",true);}
if(result["existing"]){$("#newTitle").text("You are an existing user!");$("#quickHeading").html("Account with entered email ID is partially complete, please enter details");}
else{$("#newTitle").text("Help us know you!")
$("#quickHeading").html("Entered Email / Phone is not registered with us, please enter details for <strong>Quick Sign Up</strong>");}}
else{$("#otpError").text(result["msg"]);$("#otpError").show();}}});}
function verifyEmail(){removeMessages();$("#multipleMobileUsers").attr('disabled',true);var emailIndex=$("input[name='email']:checked").val();var email=document.getElementById("verificationEmailId").value;if(!emailIndex){$('#noEmailSelected').text('Select an Email');$('#noEmailSelected').show()}
if(!email||email.trim()==''){$('#noEmailSelected').text('Enter the masked email id');$('#noEmailSelected').show()}
else{var phone=window.localStorage.getItem("username");$.ajax({url:'/user/api/map-phone/',data:{'phone':phone,'emailIndex':emailIndex,'email':email},type:"POST",success:function(result){$("#multipleMobileUsers").attr('disabled',false);if(result["msg"]==200){window.location.replace('/')}
else{$('#noEmailSelected').text(result["msg"]);$('#noEmailSelected').show();}}});}}
function registerNewPopUp(){removeMessages();$("#newRegisterationButton").attr('disabled',true);var email=document.getElementById("registerEmail").value;var phone=document.getElementById("registerPhone").value;var password=document.getElementById("registerPassword").value;var mode=window.localStorage.getItem("mode")
$.ajax({url:'/user/api/new/',data:{'username':email,'phone':phone,'password':password,"mode":mode},type:"POST",success:function(result){$("#newRegisterationButton").attr('disabled',false);if(result["msg"]=="200"){window.location.replace('/');}
else{if(result["field"]=="email"){$("#emailError").text(result["msg"]);$("#emailError").show();}
else if(result["field"]=="password"){$("#passwordError").text(result["msg"]);$("#passwordError").show();}
else if(result["field"]=="phone"){$("#phoneError").text(result["msg"]);$("#phoneError").show();}}}});}
function resendOTPPopUp(){otpcount=31;$(".loader").show();clearInterval(otpCountVar);otpCountVar=null;removeMessages();$("#otp").val("");var username=window.localStorage.getItem("username");$(".resendOTP").attr('disabled',true);$.ajax({url:'/user/api/send-otp/',data:{'username':username},type:"POST",success:function(result){$(".loader").hide();if(result["msg"]=="1000"){enable_after=result["enable_after"]
backendTime=parseInt(enable_after)
$("#resendOTP").addClass("resendOTPDisable");if(!backendTimeExecutor){backendTimeExecutor=setInterval(showTimer,1000);}}
else{$("#resendOTP").addClass("resendOTPDisable");if(!otpCountVar){otpCountVar=setInterval(otpCountFn,1000);}}}});}
function removeMessages(){$(".error-mssg").hide()
$("#otpResendSuccess").hide();}